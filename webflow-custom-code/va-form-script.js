/**
 * VA Form Custom Code for Webflow
 * 
 * Instructions:
 * 1. Add this script to your Webflow page in Page Settings > Custom Code > Footer Code
 * 2. Make sure the form has proper IDs/classes matching this script
 * 3. Update the API endpoint URL to match your serverless function
 */

(function() {
  'use strict';

  // Configuration
  const CONFIG = {
    apiEndpoint: '/api/webflow/va-submit', // Update this to your actual endpoint
    formSelector: '#va-form', // Update to match your form ID
    debug: true // Set to false in production
  };

  // Helper Functions
  function log(...args) {
    if (CONFIG.debug) {
      console.log('[VA Form]', ...args);
    }
  }

  function showError(message) {
    // You can customize this to show errors in your UI
    alert('Error: ' + message);
    log('Error:', message);
  }

  function showSuccess(message) {
    // You can customize this to show success in your UI
    alert('Success: ' + message);
    log('Success:', message);
  }

  /**
   * Generate slug from name
   */
  function generateSlug(name) {
    return name
      .toLowerCase()
      .trim()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '');
  }

  /**
   * Generate HTML for employment history
   */
  function generateEmploymentHTML(entries) {
    if (!entries || entries.length === 0) return '';

    return entries.map(entry => {
      const company = escapeHtml(entry.company || '');
      const position = escapeHtml(entry.position || '');
      const period = escapeHtml(entry.period || '');
      const description = entry.description || '';

      return `
        <div class="va-employment-entry">
          <h4 class="company">${company}</h4>
          <p class="position"><strong>${position}</strong></p>
          <p class="period">${period}</p>
          <div class="description">${description}</div>
        </div>
      `.trim();
    }).join('\n');
  }

  /**
   * Generate HTML for education
   */
  function generateEducationHTML(entries) {
    if (!entries || entries.length === 0) return '';

    return entries.map(entry => {
      const school = escapeHtml(entry.school || '');
      const degree = escapeHtml(entry.degree || '');
      const year = escapeHtml(entry.year || '');

      return `
        <div class="va-education-entry">
          <h4 class="school">${school}</h4>
          <p class="degree"><strong>${degree}</strong></p>
          <p class="year">${year}</p>
        </div>
      `.trim();
    }).join('\n');
  }

  function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Make functions available to class
  window.VAFormHelpers = {
    generateEmploymentHTML,
    generateEducationHTML,
    generateSlug,
    escapeHtml
  };

  /**
   * VA Form Manager
   */
  class VAFormManager {
    constructor(formElement) {
      this.form = formElement;
      this.employmentEntries = [];
      this.educationEntries = [];
      this.init();
    }

    init() {
      log('Initializing VA Form Manager');

      // Auto-generate slug from name
      const nameInput = this.form.querySelector('[name="name"]');
      const slugInput = this.form.querySelector('[name="slug"]');
      if (nameInput && slugInput) {
        nameInput.addEventListener('input', () => {
          if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
            slugInput.value = window.VAFormHelpers.generateSlug(nameInput.value);
            slugInput.dataset.autoGenerated = 'true';
          }
        });
      }

      // Initialize employment history section
      this.initEmploymentSection();
      
      // Initialize education section
      this.initEducationSection();

      // Handle form submission
      this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    }

    initEmploymentSection() {
      const addBtn = this.form.querySelector('[data-action="add-employment"]');
      const container = this.form.querySelector('[data-container="employment-entries"]');
      const hiddenInput = this.form.querySelector('[name="employment-richtext"]');

      if (!addBtn || !container || !hiddenInput) {
        log('Employment section elements not found');
        return;
      }

      addBtn.addEventListener('click', () => this.addEmploymentEntry(container, hiddenInput));
    }

    initEducationSection() {
      const addBtn = this.form.querySelector('[data-action="add-education"]');
      const container = this.form.querySelector('[data-container="education-entries"]');
      const hiddenInput = this.form.querySelector('[name="education-richtext"]');

      if (!addBtn || !container || !hiddenInput) {
        log('Education section elements not found');
        return;
      }

      addBtn.addEventListener('click', () => this.addEducationEntry(container, hiddenInput));
    }

    addEmploymentEntry(container, hiddenInput) {
      const entryId = 'emp-' + Date.now();
      const entryHTML = `
        <div class="employment-entry-item" data-entry-id="${entryId}">
          <div class="form-row">
            <input type="text" name="emp-company-${entryId}" placeholder="Company Name" required>
            <input type="text" name="emp-position-${entryId}" placeholder="Position" required>
          </div>
          <div class="form-row">
            <input type="text" name="emp-period-${entryId}" placeholder="Period (e.g., 2020-2023)" required>
          </div>
          <div class="form-row">
            <textarea name="emp-description-${entryId}" placeholder="Description" rows="3"></textarea>
          </div>
          <button type="button" class="remove-entry" data-remove-entry="${entryId}">Remove</button>
        </div>
      `;

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = entryHTML;
      const entryElement = tempDiv.firstElementChild;
      container.appendChild(entryElement);

      // Add remove handler
      const removeBtn = entryElement.querySelector('[data-remove-entry]');
      removeBtn.addEventListener('click', () => {
        entryElement.remove();
        this.updateEmploymentHTML(hiddenInput);
      });

      // Add input handlers to update HTML
      entryElement.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', () => this.updateEmploymentHTML(hiddenInput));
      });
    }

    addEducationEntry(container, hiddenInput) {
      const entryId = 'edu-' + Date.now();
      const entryHTML = `
        <div class="education-entry-item" data-entry-id="${entryId}">
          <div class="form-row">
            <input type="text" name="edu-school-${entryId}" placeholder="School Name" required>
            <input type="text" name="edu-degree-${entryId}" placeholder="Degree" required>
          </div>
          <div class="form-row">
            <input type="text" name="edu-year-${entryId}" placeholder="Year" required>
          </div>
          <button type="button" class="remove-entry" data-remove-entry="${entryId}">Remove</button>
        </div>
      `;

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = entryHTML;
      const entryElement = tempDiv.firstElementChild;
      container.appendChild(entryElement);

      // Add remove handler
      const removeBtn = entryElement.querySelector('[data-remove-entry]');
      removeBtn.addEventListener('click', () => {
        entryElement.remove();
        this.updateEducationHTML(hiddenInput);
      });

      // Add input handlers to update HTML
      entryElement.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => this.updateEducationHTML(hiddenInput));
      });
    }

    updateEmploymentHTML(hiddenInput) {
      const entries = [];
      const entryElements = this.form.querySelectorAll('[data-entry-id^="emp-"]');

      entryElements.forEach(element => {
        const entryId = element.dataset.entryId;
        entries.push({
          company: element.querySelector(`[name="emp-company-${entryId}"]`)?.value || '',
          position: element.querySelector(`[name="emp-position-${entryId}"]`)?.value || '',
          period: element.querySelector(`[name="emp-period-${entryId}"]`)?.value || '',
          description: element.querySelector(`[name="emp-description-${entryId}"]`)?.value || ''
        });
      });

      hiddenInput.value = window.VAFormHelpers.generateEmploymentHTML(entries);
    }

    updateEducationHTML(hiddenInput) {
      const entries = [];
      const entryElements = this.form.querySelectorAll('[data-entry-id^="edu-"]');

      entryElements.forEach(element => {
        const entryId = element.dataset.entryId;
        entries.push({
          school: element.querySelector(`[name="edu-school-${entryId}"]`)?.value || '',
          degree: element.querySelector(`[name="edu-degree-${entryId}"]`)?.value || '',
          year: element.querySelector(`[name="edu-year-${entryId}"]`)?.value || ''
        });
      });

      hiddenInput.value = window.VAFormHelpers.generateEducationHTML(entries);
    }

    collectFormData() {
      const formData = new FormData(this.form);
      const data = {};

      // Collect all form fields
      for (const [key, value] of formData.entries()) {
        // Skip employment/education individual fields (already processed to HTML)
        if (key.startsWith('emp-') || key.startsWith('edu-')) continue;
        data[key] = value;
      }

      // Ensure slug is set
      if (!data.slug && data.name) {
        data.slug = window.VAFormHelpers.generateSlug(data.name);
      }

      return data;
    }

    async handleSubmit(e) {
      e.preventDefault();
      log('Form submission started');

      const formData = this.collectFormData();
      log('Form data collected:', formData);

      // Basic validation
      if (!formData.name || !formData.summary || !formData.tagline) {
        showError('Please fill in all required fields');
        return;
      }

      // Show loading state
      const submitBtn = this.form.querySelector('[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      try {
        const response = await fetch(CONFIG.apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to save VA');
        }

        const result = await response.json();
        log('Success:', result);
        showSuccess('VA saved successfully!');
        
        // Reset form or redirect
        // this.form.reset();
        // window.location.href = '/admin/vas'; // Adjust as needed

      } catch (error) {
        log('Error:', error);
        showError(error.message || 'An error occurred while saving');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    const form = document.querySelector(CONFIG.formSelector);
    if (form) {
      new VAFormManager(form);
      log('VA Form Manager initialized');
    } else {
      log('Form not found:', CONFIG.formSelector);
    }
  }

})();

